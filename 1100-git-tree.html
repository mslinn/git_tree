---
categories: [ Bash, Git, Ruby ]
date: 2021-04-10
description: Replicate a Git directory tree to other computers.
javascriptEnd: /assets/js/clipboard.min.js
javascriptInline: new ClipboardJS('.copyBtn');
last_modified_at: 2025-10-03
layout: git
order: 1100
redirect_from:
  - /blog/2021/04/10/git-tree.html
title: Git Directory Tree Operations
---
<!-- #region intro -->
<p>
  I have several trees of Git repositories, grouped into subdirectories.
  The total number of repositories is in the hundreds.
  Here is a sanitized depiction of one of my Git directory trees:
</p>
<!-- #region directory tree -->
{% pre class='tree' label='Directory tree' wrapper_class='rounded shadow' %}
├── cadenzaHome
│   ├── cadenzaAssets
│   ├── cadenzaCode
│   │   ├── cadenzaClient
│   │   ├── cadenzaCourseCode
│   │   ├── cadenzaDependencies
│   │   ├── cadenzaLibs
│   │   ├── cadenzaServer
│   │   ├── cadenzaServerNext
│   │   └── cadenzaSupport
│   ├── cadenzaCreative
│   │   └── cadenzaCreativeTemplates
│   ├── cadenzaCreativeBackup
│   └── cadenzaCurriculum
├── django
│   ├── django
│   ├── django-oscar
│   ├── frobshop
│   ├── main
│   └── oscar
├── jekyll
│   ├── jekyllTemplate
│   └── jekyll-flexible-include-plugin
{% endpre %}
<!-- endregion -->

{% jekyll_badge
  align='right'
  name='git_tree'
  style='margin-top: 5px;'
%}
<p>
  Some Git repos are forks,
  and I defined <code>upstream</code> Git remotes for them,
  in addition to the usual <code>origin</code> remote.
</p>

<p>
  This article discusses <code>git-tree</code>,
  a Ruby gem I wrote to help me work efficiently with all those projects.
</p>
<!-- endregion -->

<!-- #region install -->
<h2 id="install">Installing <span class="code">git_tree</span></h2>
<ol style="margin-bottom: 0;">
  <li>
    See {% href match url="ruby-setup.html" %}.
  </li>
  <li>
    Your system will need to have <code>cmake</code> and associated fiddly bits installed in order
    for the build to succeed.
    On Ubuntu, type:<br>
    {% pre copyButton dedent shell %}
    {% noselect  %}yes | sudo apt install cmake libgit2-dev libssh2-1-dev pkg-config
    {% endpre %}
  </li>
  <li style="margin-bottom: 0;">
    {% href match url="rugged.html" %}
    explains that <code>rugged</code> needs to be built from source so the SSH library is included.
    Install <code>rugged</code> with SSH support:<br>
    <!-- #region -->
    {% pre copyButton dedent shell style='margin-bottom: 1em;' %}
    {% noselect %}bundle config set --global build.rugged --with-ssh<br>
    {% noselect %}gem install git_tree
    {% noselect Thanks for installing git_tree!<br>
    Successfully installed git_tree-0.2.1
    Parsing documentation for git_tree-0.2.1
    Done installing documentation for git_tree after 0 seconds
    1 gem installed %}
    {% endpre %}
    <!-- endregion -->
  </li>
  <li>
    To register the new commands, either log out and log back in, or open a new console,
    or if you {% href match label='installed Ruby using <code>rbenv</code>' url='ruby-setup.html' %} (and you should), type:
    <!-- #region pre -->
    {% pre copyButton dedent %}
    {% noselect %}rbenv rehash
    {% endpre %}
    <!-- endregion -->
  </li>
</ol>
<p>
  You should now have new shell commands:
  <code>git-commitAll</code>, <code>git-evars</code>, <code>git-exec</code>,
  <code>git-replicate</code>, and <code>git-update</code>.
  You can list them by using the <code>gem specification</code> command, like this:
</p>
<!-- #region pre -->
{% pre copyButton dedent %}
{% noselect %}gem specification git_tree executables
{% noselect - git-commitAll
- git-evars
- git-exec
- git-replicate
- git-update %}
{% endpre %}
<!-- endregion -->

<p>
  Use them as you would any other <code>git</code> command:
</p>
<!-- #region pre -->
{% pre copyButton dedent %}
{% noselect %}git commitAll ...
{% noselect <i>... output ... </i> %}<br>
{% noselect %}git evars ...
{% noselect <i>... output ... </i> %}<br>
{% noselect %}git exec ...
{% noselect <i>... output ... </i> %}<br>
{% noselect %}git replicate ...
{% noselect <i>... output ... </i> %}<br>
{% noselect %}git update ...
{% noselect <i>... output ... </i> %}<br>
{% endpre %}
<!-- endregion -->
<p>
  All of these commands have similar parameters.
  One or more environment variable references that point to the top of trees of git repositories;
  default environment variables are assumed if none are provided.
  All commands, except for <code>git-commitAll</code>, require environment variable references to be contained within
  single quotes to prevent expansion by the shell.
</p>
<!-- endregion -->

<!-- #region use cases -->
<h2 id="usecases">Use Cases</h2>

<!-- #region dependent gem management -->
<h3 id="gems">Dependent Gem Maintenance</h3>
<p>
  One of my directory trees holds Jekyll plugins, packaged as 25 gems.
  They depend on one another, and must be built in a particular order.
  Sometimes an operation must be performed on all of the plugins, and then rebuild them all.
</p>
<p>
  Most operations do not require that the projects be processed in any particular order, however
  the build process must be invoked on the dependencies first.
  It is quite tedious to do this 25 times, over and over.
</p>
<p>
  Several years ago I wrote a bash script to perform this task, but as its requirements became more complex,
  the bash script proved difficult to maintain.
  This use case is now fulfilled by the <code>git-exec</code> command
  provided by the <code>git_tree</code> gem.
  {% href label='See below for further details.' url='#git_exec' %}
</p>
<!-- endregion -->

<!-- #region replicate tree -->
<h3 id="replication">Replicating Trees of Git Repositories</h3>
<p>
  Whenever I set up an operating system for a new development computer,
  one of the tedious tasks that must be performed is to replicate
  the directory trees of Git repositories.
</p>
<p>
  It is a bad idea to attempt to copy an entire Git repository between computers,
  because the <code>.git</code> directories within them can quite large.
  So large, in fact, that it might much more time to copy than re-cloning.
</p>
<p>
  The reason is that copying the entire Git repository actually means copying the same information twice:
  first the <code>.git</code> hidden directory, complete with all the history for the project,
  and then again for the files in the currently checked out branch.
  Git repos store the entire development history of the project in their <code>.git</code> directories,
  so as they accumulate history they eventually become much larger than the
  code that is checked out at any given time.
</p>
<p>
  One morning I found myself facing the boring task of doing this manually once again.
  Instead, I wrote a bash script that scanned a Git directory tree and
  wrote out another bash script that clones the repos in the tree.
  Any additional remote references are replicated.
</p>
<p>
  Two years later, I decided to add new features to the script.
  Bash is great for short scripts,
  but it is not conducive to debugging or structured programming.
  I rewrote the bash script in Ruby, using the <code>rugged</code> gem.
  Much better!
</p>
<p>
  This use case is fulfilled by the
  {% href label='<code>git-replicate</code>' url='#git_replicate' %}
  and {% href label='<code>git-evars</code>' url='#git_evars' %} commands
  provided by this gem.
</p>
<!-- endregion -->
<!-- endregion -->

<!-- #region Usage -->
<h2 id="Usage" class="clear">Usage</h2>
<p>
  All of these commands are inherently multi-threaded.
  They consume up to 75% of the threads that your CPU can provide.
  You may notice that your computer's fan gets louder when you run these commands on large numbers of Git repositories.
</p>
<p>
  For builds and other sequential tasks, however, parallelism is inappropriate.
  Instead, it is necessary to build components in the proper order.
  Doing all the work on a single thread is a straightforward way of ensuring proper task ordering.
</p>
<p>
  Use the <code>-s/--serial</code> option when the order that Git projects are processed matters.
  All of the commands support this option.
  Execution will take much longer that without the option,
  because performing most tasks take longer to perform in sequence than performing them in parallel.
  Exceptions include old sayings like &ldquo;Nine women cannot have a baby in one month.&rdquo;
  For those exceptions, use the <code>-s/--serial</code> option.
</p>

<h3 id="git_commitAll" class="code">git-commitAll</h3>
<p>
  The <code>git-commitAll</code> command commits and pushes all changes to each repository in the tree.
  Repositories in a detached HEAD state are skipped.
</p>
<!-- #region pre -->
{% pre copyButton dedent label="git-commitAll help message" %}
$ git commitAll -h
git-commitAll - Recursively commits and pushes changes in all git repositories
under the specified DIRECTORY roots.
If no directories are given, uses default environment variables
('sites', 'sitesUbuntu', 'work') as roots.
Skips directories containing a .ignore file.
Repositories in a detached HEAD state are skipped.

Options:
  -h, --help                Show this help message and exit.
  -m, --message MESSAGE     Use the given string as the commit message.
                            (default: "-")
  -q, --quiet               Suppress normal output, only show errors.
  -s, --serial              Run tasks serially in a single thread in the order specified.
  -v, --verbose             Increase verbosity. Can be used multiple times (e.g., -v, -vv).
{% endpre %}
<!-- endregion -->

<h3 id="git_evars" class="clear code">git-evars</h3>
<p>
  The <code>git-evars</code> command writes a script that defines environment variables pointing to each git repository.
  This command should be run on the target computer.
</p>
<p>
  Only one parameter is required:
  an environment variable reference, pointing to the top-level directory to replicate.
  The environment variable reference must be contained within single quotes to prevent expansion by the shell.
</p>
<p>
  The following appends to any script in the <code>$work</code> directory called <code>.evars</code>.
  The script defines environment variables that point to each git repos pointed to by <code>$work</code>:
</p>
<!-- #region -->
{% pre shell %}
{% noselect %}git-evars '$work' >> $work/.evars
{% endpre %}
<!-- endregion -->

<h4 id="evarScript">Generated Script from <span class="code">git-evars</span></h4>
<p>
  Following is a sample of environment variable definitions.
  The <code>-z</code>/<code>--zowee</code> option generates intermediate environment variable definitions,
  making them much easier to work with.
</p>
<!-- #region -->
{% pre label='Sample Output' %}
{% noselect %}git-evars -z '$sites'
export 6of26=$sites/6of26
export computers.mslinn.com=$sites/computers.mslinn.com
export ebooks=$sites/ebooks
export expert=$sites/expert
export fonts=$sites/fonts
export intranet.mslinn.com=$sites/intranet.mslinn.com
export jekyllTemplate=$sites/jekyllTemplate
export lyrics=$sites/lyrics
export metamusic=$sites/metamusic
export music.mslinn.com=$sites/music.mslinn.com
export photos=$sites/photos
export supportingLiterature=$sites/supportingLiterature
export www.scalacourses.com=$sites/www.scalacourses.com
{% endpre %}
<!-- endregion -->

<p>
  The environment variable definitions are meant to be saved into a file that is <code>source</code>d upon boot.
  While you could place them in a file like <code>~/.bashrc</code>,
  the author&rsquo;s preference is to instead place them in <code>$work/.evars</code>,
  and add the following to <code>~/.bashrc</code>:
</p>
<!-- #region -->
{% pre label='~/.bashrc snippet' %}
source "$work/.evars"
{% endpre %}
<!-- endregion -->

<p>
  Thus each time you log in, the environment variable definitions will have been re-established.
  You can therefore change directory to any of the cloned projects, like this:
</p>
<!-- #region -->
{% pre shell copyButton %}
{% noselect %}cd $git_root

{% noselect %}cd $my_project
{% endpre %}
<!-- endregion -->

<h3 id="git_exec" class="code">git-exec</h3>
<p>
  The <code>git-exec</code> command can be run on any computer.
  The command requires two parameters.
  The first parameter indicates the directory or directories to process.
  3 forms are accepted:
</p>
<ol>
  <li>A directory name, which may be relative or absolute.</li>
  <li>
    An environment variable reference,
    which must be contained within single quotes to prevent expansion by the shell.
  </li>
  <li>
    A list of directory names, which may be relative or absolute, and may contain environment variables.
  </li>
</ol>

<h4 id="exec1">Example 1</h4>
<p>
  For all subdirectories of current directory,
  update <code>Gemfile.lock</code> and install a local copy of the gem:
</p>
<!-- #region -->
{% pre copyButton dedent shell %}
{% noselect %}git-exec \
  '$jekyll_plugin_logger
  $jekyll_draft
  $jekyll_plugin_support
  $jekyll_all_collections
  $jekyll_plugin_template
  $jekyll_flexible_include_plugin
  $jekyll_href
  $jekyll_img
  $jekyll_outline
  $jekyll_plugin_template
  $jekyll_pre
  $jekyll_quote'
  'bundle &amp;&amp; bundle update &amp;&amp; rake install'
{% endpre %}
<!-- endregion -->

<h4 id="exec2">Example 2</h4>
<p>
  This example shows how to display the version of projects that
  create gems under the directory pointed to by <code>$my_plugins</code>.
</p>
<p>
  An executable script is required on the <code>PATH</code>, so <code>git-exec</code>
  can invoke it as it loops through the subdirectories.
  I call this script <code>version</code>, and it is written in <code>bash</code>,
  although the language used is not significant:
</p>
{% flexible_include copyButton download pre file='$mslinn_bin/misc/version' label="version" %}

<p style="margin-top: 1em;">
  Call it like this:
</p>
<!-- #region -->
{% pre copyButton dedent shell %}
{% noselect %}git-exec '$my_plugins' version
{% noselect jekyll_all_collections v0.3.3
jekyll_archive_create v1.0.2
jekyll_archive_display v1.0.1
jekyll_auto_redirect v0.1.0
jekyll_basename_dirname v1.0.3
jekyll_begin_end v1.0.1
jekyll_bootstrap5_tabs v1.1.2
jekyll_context_inspector v1.0.1
jekyll_download_link v1.0.1
jekyll_draft v1.1.2
jekyll_flexible_include_plugin v2.0.20
jekyll_from_to_until v1.0.3
jekyll_href v1.2.5
jekyll_img v0.1.5
jekyll_nth v1.1.0
jekyll_outline v1.2.0
jekyll_pdf v0.1.0
jekyll_plugin_logger v2.1.1
jekyll_plugin_support v0.7.0
jekyll_plugin_template v0.3.0
jekyll_pre v1.4.1
jekyll_quote v0.4.0
jekyll_random_hex v1.0.0
jekyll_reading_time v1.0.0
jekyll_revision v0.1.0
jekyll_run v1.0.1
jekyll_site_inspector v1.0.0
jekyll_sort_natural v1.0.0
jekyll_time_since v0.1.3 %}
{% endpre %}
<!-- endregion -->

<h4 id="exec3">Example 3</h4>
<p>
  List the projects under the directory pointed to by <code>$my_plugins</code>
  that have a <code>demo/</code> subdirectory:
</p>
<!-- #region -->
{% pre copyButton dedent shell %}
{% noselect %}git-exec '$my_plugins' \
  'if [ -d demo ]; then realpath demo; fi'
{% noselect /mnt/c/work/jekyll/my_plugins/jekyll-hello/demo
/mnt/c/work/jekyll/my_plugins/jekyll_all_collections/demo
/mnt/c/work/jekyll/my_plugins/jekyll_archive_create/demo
/mnt/c/work/jekyll/my_plugins/jekyll_download_link/demo
/mnt/c/work/jekyll/my_plugins/jekyll_draft/demo
/mnt/c/work/jekyll/my_plugins/jekyll_flexible_include_plugin/demo
/mnt/c/work/jekyll/my_plugins/jekyll_from_to_until/demo
/mnt/c/work/jekyll/my_plugins/jekyll_href/demo
/mnt/c/work/jekyll/my_plugins/jekyll_img/demo
/mnt/c/work/jekyll/my_plugins/jekyll_outline/demo
/mnt/c/work/jekyll/my_plugins/jekyll_pdf/demo
/mnt/c/work/jekyll/my_plugins/jekyll_plugin_support/demo
/mnt/c/work/jekyll/my_plugins/jekyll_plugin_template/demo
/mnt/c/work/jekyll/my_plugins/jekyll_pre/demo
/mnt/c/work/jekyll/my_plugins/jekyll_quote/demo
/mnt/c/work/jekyll/my_plugins/jekyll_revision/demo
/mnt/c/work/jekyll/my_plugins/jekyll_time_since/demo %}
{% endpre %}
<!-- endregion -->

<h3 id="git_replicate" class="code">git-replicate</h3>
<p>
  This command generates a shell script to replicate a tree of git repositories.
  ROOTS can be directory names or environment variable references (e.g., '$work').
  Multiple roots can be specified in a single quoted string.
</p>
<!-- #region -->
{% pre shell %}
{% noselect %}git-replicate '$work' > work.sh                # Replicate repos under $work
{% noselect %}git-replicate '$work $sites' > replicate.sh    # Replicate repos under $work and $sites
{% endpre %}
<!-- endregion -->
<p>
  The generated environment variables will all be relative to the
  path pointed to by the expanded environment variable that you provided.
  You will understand what this means once you look at the generated script.
</p>
<p>
  When <code>git-replicate</code> completes,
  edit the generated script to suit, then
  copy it to the target machine and run it.
  The following example copies the script to <code>machine2</code> and runs it:
</p>
<!-- #region -->
{% pre shell %}
{% noselect %}scp work.sh machine2:

{% noselect %}ssh machine2 work.sh
{% endpre %}
<!-- endregion -->

<h4 id="replicateScript">Generated Script from <span class="code">git-replicate</span></h4>
<p>
  Following is a sample of one section, which is repeated for every git repo that is processed:
  You can edit them to suit.
</p>
<!-- #region -->
{% pre shell %}
{% noselect %}if [ ! -d "sinatra/sinatras-skeleton/.git" ]; then
  mkdir -p 'sinatra'
  pushd 'sinatra' > /dev/null
  git clone git@github.com:mslinn/sinatras-skeleton.git
  git remote add upstream 'https://github.com/simonneutert/sinatras-skeleton.git'
  popd > /dev/null
fi
{% endpre %}
<!-- endregion -->

<h3 id="git_update" class="code">git-update</h3>
<p>
  The <code>git-update</code> command updates each repository in the tree.
</p>
<!-- endregion -->

<!-- #region Additional Information -->
<h2 id="additional-information">Additional Information</h2>
<p>
More information is available on
<a href="https://www.mslinn.com/git/1100-git-tree.html">Mike Slinn’s website</a>
</p>
<!-- endregion -->

<!-- #region Development -->
<h2 id="development">Development</h2>
<p>
After checking out the repo, run <code>bin/setup</code> to install dependencies.
</p>
<p>
Run the following to create a directory tree for testing.
</p>
{% pre copyButton dedent shell %}
{% noselect %}ruby bin/make_test_directory.rb
{% endpre %}
<p>
You can run <code>bin/console</code> for an interactive prompt that will allow you to experiment.
</p>
{% pre copyButton dedent shell %}
{% noselect %}bin/console
irb(main):001:0> GitTree.command_replicate 'demo'

irb(main):002:0> GitTree.command_evars 'demo'
{% endpre %}

<h3 id="build-install-locally">Build and Install Locally</h3>
<p>
To build and install this gem onto your local machine, run:
</p>
{% pre copyButton dedent shell %}
{% noselect %}bundle exec rake install
{% endpre %}
<p>
Examine the newly built gem:
</p>
{% pre copyButton dedent shell %}
{% noselect %}gem info git_tree

*** LOCAL GEMS ***

git_tree (0.3.0)
    Author: Mike Slinn
    Homepage: https://www.mslinn.com/git/1100-git-tree.html
    License: MIT
    Installed at: /home/mslinn/.rbenv/versions/3.4.6/lib/ruby/gems/3.4.0

    Installs five commands that walk a git directory tree and perform tasks.
{% endpre %}

<h3 id="build-push-rubygems">Build and Push to RubyGems</h3>
<p>
To release a new version:
</p>
<ol>
  <li>Update the version number in <code>version.rb</code>.</li>
  <li>Commit all changes to git; if you don't the next step might fail with an
     unexplainable error message.</li>
  <li>Run the following:</li>
</ol>
{% pre copyButton dedent shell %}
{% noselect %}bundle exec rake release
{% endpre %}
<p>
The above creates a git tag for the version, commits the created tag,
and pushes the new <code>.gem</code> file to [RubyGems.org](https://rubygems.org).
</p>
<!-- endregion -->

<!-- #region Contributing -->
<h2 id="contributing">Contributing</h2>
<ol>
  <li>Fork the project</li>
  <li>Create a descriptively named feature branch</li>
  <li>Add your feature</li>
  <li>Submit a pull request</li>
</ol>
<!-- endregion -->

<!-- #region License -->
<h2 id="license">License</h2>
<p>
The gem is available as open source under the terms of the
[MIT License](https://opensource.org/licenses/MIT).
</p>
<!-- endregion -->
